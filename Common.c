//==============================================================================
///
/// @file Common.c
///
///
/// @brief Common utils for wolf test.
///
/// Copyright (c) 2022 Rockwell Automation Technologies, Inc.
/// All rights reserved.
//==============================================================================

//------------------------------------------------------------------------------
// Include files
//------------------------------------------------------------------------------
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <stddef.h>
#include <string.h>

#include <crazywolf/Common.h>

//-----------------------------------------------------------------------------
// Constants
//-----------------------------------------------------------------------------

//-----------------------------------------------------------------------------
// Macros
//-----------------------------------------------------------------------------

//-----------------------------------------------------------------------------
// Local data types
//-----------------------------------------------------------------------------

//-----------------------------------------------------------------------------
// Local constants
//-----------------------------------------------------------------------------

//-----------------------------------------------------------------------------
// Global references
//-----------------------------------------------------------------------------

//-----------------------------------------------------------------------------
// Forward function declarations
//-----------------------------------------------------------------------------

//-----------------------------------------------------------------------------
// Variable definitions
//-----------------------------------------------------------------------------

//-----------------------------------------------------------------------------
// Function definitions
//-----------------------------------------------------------------------------



uint8_t* CW_Common_Allocacheck(size_t stackMaxBytes)
{
    uint8_t* pAlloca = alloca(stackMaxBytes);
    memset(pAlloca, 0xccU, stackMaxBytes);
    return pAlloca;
} // End: CW_Common_Allocacheck()

void CW_Common_Allocaprint(uint8_t* pAlloca,
                           size_t stackMaxBytes)
{
    size_t freeStack = 0;
    for (;
         freeStack < stackMaxBytes && pAlloca[freeStack] == 0xcc;
         freeStack++)
    {
        ; // just count
    }

    printf("Stack consumed %d\n", stackMaxBytes-freeStack);
} // End: CW_Common_Allocaprint()

//-----------------------------------------------------------------------------
///
/// @brief Dies with a message.
///
/// @param[in] pErrorMsg - error message
///
//-----------------------------------------------------------------------------
void CW_Common_Die(const char* pErrorMsg)
{
    perror(pErrorMsg);
    exit(1);
} // End: CW_Common_Die()
